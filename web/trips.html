<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ангажименти</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <header>
        <h1>Ангажименти</h1>
    </header>
    <main>
        <button class="btn-primary" onclick="goHome()">Начало</button>
        <div class="container">
            <table id="tripList" class="azure-table">
                <thead>
                    <tr>
                        <th>Автомобил</th>
                        <th>Дирекция</th>
                        <th>Период</th>
                        <th>Маршрут</th>
                        <th>Действие</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <form id="editTripForm" class="form-hidden">
            <label for="editCarSelect">Избери модел:</label>
            <select id="editCarSelect"></select>
            <input type="text" id="editDepartment" placeholder="Department">
            <input type="date" id="editUsageDate">
            <input type="text" id="editDestination" placeholder="Destination">
            <input type="hidden" id="editTripId">
            <button type="button" class="btn-primary" onclick="updateTrip()">Запиши</button>
            <button type="button" class="btn-secondary" onclick="hideEditForm()">Откажи</button>
        </form>
        <button id="addButton" class="btn-primary">Добави ангажимент</button>
    </main>
    <script>
        function goHome() {
            window.location.href = '/web/'; 
        }
        async function fetchTrips() {
            const response = await fetch('/api/bookings');
            const trips = await response.json();
            const tripListTbody = document.getElementById('tripList').getElementsByTagName('tbody')[0];
            tripListTbody.innerHTML = '';
            trips.forEach(trip => {
                trip.bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${booking.car_model_name}</td><td>${booking.department}</td><td>${booking.usage_date}</td><td>${booking.destination}</td><td><button class="btn-icon" onclick="showEditForm(${booking.id}, ${booking.car_model_id}, '${booking.department}', '${booking.usage_date}', '${booking.destination}')"><i class="fas fa-edit"></i></button><button class="btn-icon" onclick="deleteTrip(${booking.id})"><i class="fas fa-trash-alt"></i></button></td>`;
                    tripListTbody.appendChild(row);
                });
            });
        }

        async function fetchCarModels() {
            const response = await fetch('/api/cars');
            const carModels = await response.json();
            const carSelect = document.getElementById('editCarSelect');
            carSelect.innerHTML = '';
            carModels.forEach(carModel => {
                const option = document.createElement('option');
                option.value = carModel.id;
                option.textContent = carModel.name;
                carSelect.appendChild(option);
            });
        }

        window.onload = () => {
            fetchTrips();
            fetchCarModels();
        };

        function showEditForm(tripId, carModelId, department, usageDate, destination) {
            document.getElementById('editTripForm').classList.remove('form-hidden');
            document.getElementById('editCarSelect').value = carModelId;
            document.getElementById('editDepartment').value = department;
            document.getElementById('editUsageDate').value = usageDate;
            document.getElementById('editDestination').value = destination;
            document.getElementById('editTripId').value = tripId;
        }

        function hideEditForm() {
            document.getElementById('editTripForm').classList.add('form-hidden');
        }

        function updateTrip() {
            const tripId = document.getElementById('editTripId').value;
            const carModelId = parseInt(document.getElementById('editCarSelect').value);
            const department = document.getElementById('editDepartment').value;
            const usageDate = document.getElementById('editUsageDate').value;
            const destination = document.getElementById('editDestination').value;

            fetch(`/api/bookings/${tripId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    car_model_id: carModelId, 
                    department: department, 
                    usage_date: usageDate,
                    destination: destination
                })
            })
            .then(response => {
                if (response.ok) {
                    fetchTrips(); 
                    hideEditForm();
                } else {
                    alert('Failed to edit trip');
                }
            })
            .catch(error => {
                console.error('Error editing trip:', error);
                alert('Error editing trip');
            });
        }

        function deleteTrip(tripId) {
            const confirmDelete = confirm('Are you sure you want to delete this trip?');
            if (confirmDelete) {
                fetch(`/api/bookings/${tripId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        fetchTrips();
                    } else {
                        alert('Failed to delete trip');
                    }
                })
                .catch(error => {
                    console.error('Error deleting trip:', error);
                    alert('Error deleting trip');
                });
            }
        }
    </script>
</body>
</html>
